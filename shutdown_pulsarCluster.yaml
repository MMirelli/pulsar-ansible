---
# Stop brokers 
- hosts: broker
  any_errors_fatal: true
  become: "{{ sudo_needed }}"
  become_method: sudo
  vars:
    srvStarted: true
  roles:
    # Check the current status of brokers
    - { role: misc/_check_svc_status, 
        srv_component: 'broker', 
        srv_ports: [
            "{% if enable_brkr_tls is defined and enable_brkr_tls|bool %}{{ web_svc_port_tls }}{% else %}{{ web_svc_port }}{% endif %}",
            "{% if enable_brkr_tls is defined and enable_brkr_tls|bool %}{{ broker_svc_port_tls }}{% else %}{{ broker_svc_port }}{% endif %}"
          ] 
      }
    # Stop brokers
    - { role: pulsar/common/pulsar_stopSvc, 
        srv_component: 'broker', 
        srv_ports: [
            "{% if enable_brkr_tls is defined and enable_brkr_tls|bool %}{{ web_svc_port_tls }}{% else %}{{ web_svc_port }}{% endif %}",
            "{% if enable_brkr_tls is defined and enable_brkr_tls|bool %}{{ broker_svc_port_tls }}{% else %}{{ broker_svc_port }}{% endif %}"
          ] 
      }

# Stop bookies 
- hosts: bookkeeper
  any_errors_fatal: true
  become: "{{ sudo_needed }}"
  become_method: sudo
  # serial: 1
  roles:
    # Check the current status of bookies
    - { role: misc/_check_svc_status, 
        srv_component: 'bookie', 
        srv_ports: ["{{ bookie_listening_port }}"] }
    # Stop bookies
    - { role: pulsar/common/pulsar_stopSvc, 
        srv_component: 'bookie', 
        srv_ports: ["{{ bookie_listening_port }}"] }
  post_tasks:
    - name: If requested, clean-up bookkeeper data directories
      shell: rm -rf {{ item }}
      # args:
      #   warn: no
      with_items:
        - "{{ bookie_storage_mnt_paths }}"
      when: purge_pulsar is defined and purge_pulsar|bool

# Stop zookeepers 
- hosts: zookeeper
  any_errors_fatal: true
  become: "{{ sudo_needed }}"
  become_method: sudo
  # serial: 1
  roles:
    # Check the current status of bookies
    - { role: misc/_check_svc_status, 
        srv_component: 'zookeeper', 
        srv_ports: ["{{ zk_clnt_port }}"] }
    # Stop bookies
    - { role: pulsar/common/pulsar_stopSvc, 
        srv_component: 'zookeeper', 
        srv_ports: ["{{ zk_clnt_port }}"] }
  post_tasks:
    - name: If requested, clean-up zookeeper data directories
      shell: rm -rf {{ zk_storage_mnt_path }}
      # args:
      #   warn: no
      when: purge_pulsar is defined and purge_pulsar|bool  

# Clean up pulsar binaries and logs
- hosts: pulsarServer
  any_errors_fatal: true
  become: "{{ sudo_needed }}"
  become_method: sudo
  tasks:
  - name: If requested, clean-up pulsar binaries and logs
    file:
      path: "{{ item }}"
      state: absent
    with_items:
      - "{{ tgt_pulsar_inst_dir }}"
      - "{{ tgt_pulsar_log_homedir }}"
      - "{{ tgt_pulsar_bookie_journal_data_homedir }}"
      - "{{ tgt_pulsar_bookie_ledger_data_homedir }}"
      - "{{ tgt_pulsar_zk_data_homedir }}"
      # - "{{ tgt_pkg_dir }}"
    when: purge_pulsar is defined and purge_pulsar|bool